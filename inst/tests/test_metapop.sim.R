require(testthat)
require(pez)
context("Metapopulation and phylogeny simulation")

#Tests
# - no explicit test of edge2phylo because these test it
test_that("sim.meta.comm", {
    set.seed(123)
    test <- sim.meta.comm()
    expect_that(test, equals(structure(list(species = structure(c(23, 5, 34, 30, 18, 23, 31, 
2, 1, 20, 9, 10, 7, 8, 9, 8, 0, 8, 0, 0, 0, 8, 0, 0, 0, 9, 0, 
0, 11, 8, 8, 10, 9, 10, 0, 8, 9, 10, 13, 0, 0, 0, 0, 10, 10, 
9, 9, 0, 10, 13, 0, 7, 8, 12, 0, 0, 0, 7, 11, 11, 8, 9, 8, 7, 
0, 7, 8, 7, 0, 9, 7, 7, 0, 0, 12, 0, 7, 7, 12, 0, 0, 12, 11, 
11, 0, 8, 0, 10, 10, 9, 0, 11, 7, 9, 0, 0, 8, 9, 0, 12, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 14, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 14, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 15, 0, 0, 0, 4, 
0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 5, 
0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 3, 4, 6, 0, 0, 0, 
7, 4, 3, 5, 0, 4, 0, 0, 3, 0, 5, 0, 5, 0, 4, 0, 0, 0, 5, 0, 0, 
0, 3, 6, 3, 3, 4, 3, 3, 0, 0, 6, 5, 0, 4, 4, 0, 5, 3, 6, 3, 0, 
3, 0, 7, 4, 0, 0, 3, 3, 6, 5, 5, 0, 6, 0, 0, 4, 8, 3, 3, 0, 8, 
0, 0, 6, 3, 0, 6, 0, 0, 4, 0, 0, 0, 5, 0, 5, 0, 0, 4, 0, 0, 9, 
3, 5, 6, 4, 8, 0, 6, 4, 4, 0, 0, 0, 0, 4, 0, 0, 3, 4, 2, 3, 0, 
0, 6, 0, 4, 0, 2, 0, 5, 0, 0, 3, 3, 0, 0, 2, 3, 5, 2, 2, 3, 4, 
0, 0, 2, 0, 4, 4, 0, 3, 0, 0, 6, 0, 3, 0, 0, 2, 0, 0, 0, 2, 4, 
0, 2, 2, 3, 3, 4, 5, 6, 2, 2, 0, 2, 0, 0, 3, 2, 0, 0, 2, 0, 0, 
0, 0, 4, 0, 0, 4, 0, 3, 2, 0, 0, 0, 3, 2, 3, 3, 2, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 12, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 
11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 
0, 0, 12, 0, 0, 0, 0, 13, 0, 14, 0, 0, 0, 12, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 9, 0, 11, 
0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9, 0, 
0, 10, 0, 0, 0, 0, 0, 9, 12, 0, 0, 10, 0, 8, 0, 0, 0, 0, 0, 12
), .Dim = c(10L, 10L, 8L)), environment = structure(c(8L, 9L, 
14L, 10L, 10L, 15L, 11L, 5L, 4L, 13L, 11L, 11L, 10L, 8L, 15L, 
11L, 3L, 7L, 6L, 8L, 6L, 8L, 4L, 6L, 6L, 8L, 5L, 12L, 12L, 12L, 
12L, 11L, 9L, 9L, 8L, 7L, 12L, 9L, 13L, 7L, 8L, 8L, 12L, 9L, 
10L, 9L, 9L, 14L, 9L, 14L, 5L, 6L, 10L, 11L, 8L, 8L, 6L, 11L, 
13L, 12L, 11L, 12L, 9L, 9L, 7L, 7L, 11L, 9L, 7L, 10L, 9L, 10L, 
11L, 8L, 12L, 9L, 11L, 13L, 11L, 8L, 13L, 13L, 11L, 10L, 8L, 
14L, 8L, 16L, 14L, 9L, 6L, 15L, 10L, 13L, 8L, 7L, 7L, 11L, 9L, 
14L), .Dim = c(10L, 10L))), .Names = c("species", "environment"
))))
})


test_that("sim.meta.phy.comm", {
    set.seed(123)
    test <- sim.meta.phy.comm()
    expect_that(test, equals(structure(list(species = structure(c(0, 1, 9, 0, 8, 4, 0, 0, 
0, 9, 7, 0, 0, 1, 5, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 4, 
6, 6, 7, 3, 1, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 3, 2, 0, 0, 0, 5, 
0, 0, 0, 0, 1, 4, 2, 0, 0, 0, 6, 1, 0, 0, 2, 0, 6, 0, 0, 0, 0, 
3, 0, 0, 0, 2, 0, 0, 0, 0, 10, 0, 0, 5, 0, 0, 3, 0, 0, 1, 1, 
0, 5, 7, 0, 0, 0, 7, 0, 10, 0, 11, 10, 0, 0, 11, 1, 0, 0, 0, 
6, 7, 6, 2, 9, 0, 0, 4, 0, 2, 0, 0, 0, 1, 1, 1, 0, 1, 5, 0, 1, 
2, 2, 6, 6, 2, 1, 1, 0, 0, 0, 5, 9, 0, 1, 0, 1, 7, 0, 1, 0, 0, 
10, 3, 0, 0, 3, 0, 1, 0, 5, 8, 0, 2, 0, 0, 0, 2, 0, 0, 4, 6, 
0, 0, 0, 4, 7, 7, 4, 4, 0, 0, 3, 0, 13, 0, 5, 10, 3, 1, 0, 0, 
2, 1, 1, 2, 0, 0, 2, 8, 3, 4, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 6, 
0, 2, 0, 0, 0, 0, 0, 0, 3, 0, 2, 0, 3, 5, 0, 0, 2, 0, 0, 0, 0, 
5, 1, 3, 0, 0, 0, 0, 0, 1, 0, 0, 2, 5, 7, 4, 0, 0, 0, 0, 3, 0, 
0, 0, 0, 0, 0, 0, 0, 6, 6, 0, 0, 0, 0, 1, 3, 0, 0, 0, 4, 0, 0, 
0, 3, 0, 4, 0, 0, 9, 0, 0, 12, 8, 0, 0, 0, 0, 0, 0, 3, 8, 4, 
4, 15, 4, 0, 0, 2, 0, 7, 1, 0, 0, 0, 0, 7, 4, 3, 8, 4, 4, 1, 
0, 3, 2, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 8, 0, 3, 0, 0, 0, 0, 0, 
0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 7, 6, 0, 0, 0, 
6, 1, 0, 5, 10, 0, 4, 2, 6, 4, 0, 14, 0, 3, 0, 0, 8, 3, 7, 6, 
11, 0, 0, 9, 4, 3, 0, 1, 0, 0, 2, 0, 0, 0, 0, 0, 6, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 13, 12, 0, 0, 7, 12, 0, 6, 0, 4, 0, 4, 0, 
0, 0, 4, 4, 0, 0, 0, 0, 0, 5, 0, 7, 0, 4, 4, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 14, 0, 5, 0, 0, 4, 0, 0, 0, 5, 5, 4, 0, 4, 0, 0, 
5, 0, 20, 7, 0, 0, 8, 7, 8, 7, 0, 9, 6, 0, 3, 0, 0, 0, 5, 7, 
0, 4, 0, 0, 0, 6, 14, 5, 7, 5, 6, 0, 6, 7, 0, 5, 0, 0, 5, 0, 
4, 7, 4, 0, 0, 0, 0, 3, 0, 0, 2, 4, 4, 0, 2, 2, 0, 0, 0, 0, 0, 
0, 7, 0, 0, 4, 0, 0, 0, 7, 0, 0, 8, 0, 3, 3, 0, 0, 2, 8, 0, 0, 
3, 0, 0, 12, 2, 5, 15, 0, 6, 0, 0, 0, 7, 0, 2, 1, 12, 21, 0, 
5, 4, 0, 0, 0, 0, 0, 0, 0, 0, 7, 4, 5, 0, 0, 0, 2, 0, 0, 4, 0, 
0, 0, 0, 0, 0, 0, 4, 0, 3, 0, 0, 0, 0, 0, 2, 0, 7, 3, 0, 2, 0, 
8, 3, 0, 11, 0, 0, 0, 0, 0, 2, 0, 4, 0, 0, 0, 0, 0, 4, 4, 3, 
0, 0, 4, 7, 0, 5, 0, 0, 0, 8, 3, 0, 4, 2, 0, 0, 0, 4, 0, 0, 0, 
3, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 3, 0, 0, 0, 11, 0, 5, 4, 2, 
0, 3, 1, 3, 4, 3, 0, 0, 3, 2, 3, 11, 5, 0, 0, 0, 5, 0, 0, 13, 
7, 0, 0, 4, 0, 0, 0, 0, 12, 24, 9, 0, 3, 2, 0, 3, 4, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 13, 4, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 3, 
1, 1, 0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 0, 0, 7, 0, 5, 3, 1, 6, 
3, 1, 0, 1, 1, 0, 0, 14, 7, 7, 0, 0, 0, 6, 0, 0, 2, 0, 2, 0, 
0, 0, 11, 6, 0, 1, 0, 0, 8, 1, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 5, 
0, 5, 0, 0, 0, 0, 0, 0, 5, 0, 5, 4, 0, 0, 0, 0, 5, 17, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 
0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), .Dim = c(10L, 10L, 13L
)), environment = structure(c(8L, 9L, 14L, 10L, 10L, 15L, 11L, 
5L, 4L, 13L, 11L, 11L, 10L, 8L, 15L, 11L, 3L, 7L, 6L, 8L, 6L, 
8L, 4L, 6L, 6L, 8L, 5L, 12L, 12L, 12L, 12L, 11L, 9L, 9L, 8L, 
7L, 12L, 9L, 13L, 7L, 8L, 8L, 12L, 9L, 10L, 9L, 9L, 14L, 9L, 
14L, 5L, 6L, 10L, 11L, 8L, 8L, 6L, 11L, 13L, 12L, 11L, 12L, 9L, 
9L, 7L, 7L, 11L, 9L, 7L, 10L, 9L, 10L, 11L, 8L, 12L, 9L, 11L, 
13L, 11L, 8L, 13L, 13L, 11L, 10L, 8L, 14L, 8L, 16L, 14L, 9L, 
6L, 15L, 10L, 13L, 8L, 7L, 7L, 11L, 9L, 14L), .Dim = c(10L, 10L
)), tree = structure(list(edge = structure(c(14, 14, 14, 14, 
14, 14, 14, 14, 15, 15, 18, 18, 17, 17, 19, 19, 16, 16, 1, 2, 
15, 3, 16, 4, 5, 17, 18, 6, 7, 8, 19, 9, 10, 11, 12, 13), .Dim = c(18L, 
2L)), tip.label = c("r_1", "r_2", "r_3", "r_4", "r_5", "r_6", 
"r_7", "r_8", "r_9", "r_10", "r_11", "r_12", "r_13"), edge.length = c(11, 
11, 2, 11, 8, 11, 11, 4, 2, 9, 7, 7, 2, 7, 5, 5, 3, 2), Nnode = 6L, 
    traits = NULL), .Names = c("edge", "tip.label", "edge.length", 
"Nnode", "traits"), class = "phylo"), lookup = structure(list(
    phy = c("r_1", "r_2", "r_7", "r_3", "r_12", "r_4", "r_5", 
    "r_10", "r_6", "r_8", "r_9", "r_11", "r_13"), abund = c(1, 
    2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13)), .Names = c("phy", 
"abund"), row.names = c(NA, 13L), class = "data.frame")), .Names = c("species", 
"environment", "tree", "lookup"))))
})

